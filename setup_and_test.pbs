#!/bin/bash
#PBS -N lingua_setup
#PBS -l walltime=05:00:00
#PBS -l select=1:ncpus=8:mem=20gb:ngpus=1


# 1. Load minimal environment
module purge
source $HOME/miniconda3/etc/profile.d/conda.sh


# 2. Create GPU env only if it doesn't exist
if ! conda env list | grep -q '^lingua'; then
	echo ">>> Creating Conda env 'lingua' ..."
	conda create -y -n lingua \
		python=3.11 \
		pytorch=2.3 torchvision torchaudio \
		pytorch-cuda=11.8 \
		git-lfs ninja \
		-c pytorch -c nvidia -c conda-forge
	conda activate lingua
#	pip install flash-attn==2.5.4 xformers==0.0.37
	pip install xformers==0.0.37 || true
	pip install flash-attn=2.5.4 --no-build-isolation 2>/dev/null || \
		echo "Flash-Attention wheel not found; skipping."
	pip install -r $HOME/Efficient-LLMs/requirements.txt
else
	echo ">>> Conda env 'lingua' already exists"
	conda activate lingua
fi


# 3. Sanity check GPU visibility
python - <<'PY'
import torch, sys, subprocess
print("CUDA visible? ", torch.cuda.is_available())
print("GPU count: ", torch.cuda.device_count())
print("Torch & CUDA: ", torch.__version__, torch.version.cuda)
try:
	import flash_attn_2 as fa
	print("Flash-Attn: ", fa.__version__)
except ModuleNotFoundError:
	print("Flash-Attn: NOT installed")
PY
echo "-------------------------------------------------------"


# 4. Mini dataset 
DATA=~/Efficient-LLMs/data/sanity/c4-00000.json
if [ ! -f "$DATA" ]; then
	mkdir -p ~Efficient-LLMs/data/sanity
	wget -q -O - https://huggingface.co/datasets/allenai/c4/resolve/main/en/c4-train.00000-of-01024.json.gz | \
		gunzip > "$DATA"
fi


# 5. 10-step smoke test
cd ~/Efficient-LLMs
python apps/main/train.py \
	apps/main/configs/baselines/base_qwen_600M.yaml \
	dataset.path=data/sanity \
	trainer.max_steps=10 \
	logging.freq=1

